<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Singing HUGO</title>
  <meta name="description" content="Singing HUGO inquiry portal" />
  <style>
    :root{
      --bg: #0b0d12;
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --glass: rgba(16,18,26,.54);
      --glass2: rgba(16,18,26,.72);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --maxw: 760px;
      --vh: 1vh;
      color-scheme: dark;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      overflow:hidden;
    }

    /* WebGL canvas */
    #bg{
      position:fixed;
      inset:0;
      z-index:0;
      display:block;
      width:100%;
      height:100%;
      touch-action:none;
    }

    /* vignette + subtle grain overlay */
    .fx{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 60%, rgba(0,0,0,.70) 100%),
        radial-gradient(900px 500px at 70% 70%, rgba(0,0,0,0) 0%, rgba(0,0,0,.20) 65%, rgba(0,0,0,.55) 100%);
      opacity:.95;
    }
    .fx::after{
      content:"";
      position:absolute;
      inset:-20%;
      opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      transform: rotate(3deg);
    }

    header{
      position:fixed;
      top: max(14px, env(safe-area-inset-top));
      left: max(14px, env(safe-area-inset-left));
      right: max(14px, env(safe-area-inset-right));
      z-index:3;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      pointer-events:none;
    }

    .brand{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(10,12,18,.35);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 12px 40px rgba(0,0,0,.28);
      user-select:none;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.75);
      box-shadow: 0 0 0 4px rgba(255,255,255,.10);
    }
    .brand b{font-weight:650; letter-spacing:.2px}
    .brand span{color:var(--muted); font-size:13px}

    .cta{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill{
      border: 1px solid var(--stroke);
      background: rgba(10,12,18,.35);
      color: var(--fg);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      user-select:none;
    }
    .pill:hover{border-color:var(--stroke2)}
    .pill .k{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:8px;
      opacity:.9;
    }

    main{
      position:relative;
      z-index:2;
      height: calc(var(--vh) * 100);
      display:grid;
      place-items:center;
      padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
    }

    .card{
      width:min(var(--maxw), 96vw);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--glass), rgba(16,18,26,.35));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .cardTop{
      padding: 26px 26px 18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }
    h1{
      margin:0;
      font-size: clamp(22px, 3.3vw, 34px);
      letter-spacing:.2px;
      line-height:1.05;
      font-weight:720;
    }
    .sub{
      margin-top:10px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
      max-width: 56ch;
    }
    .hint{
      text-align:right;
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
      min-width: 160px;
    }
    .hint a{color:var(--fg); text-decoration:none; border-bottom:1px solid rgba(255,255,255,.18)}
    .hint a:hover{border-bottom-color:rgba(255,255,255,.35)}
    .hint small{display:block; opacity:.9; margin-top:6px}

    .cardBody{
      padding: 18px 26px 22px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:stretch;
    }

    .field{
      flex:1;
      position:relative;
    }
    input, textarea{
      width:100%;
      font: inherit;
      color: var(--fg);
      background: rgba(8,10,14,.48);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px 14px;
      outline:none;
      transition: border-color .18s ease, transform .18s ease, background .18s ease;
    }
    textarea{
      min-height: 56px;
      max-height: 160px;
      resize: vertical;
      padding-right: 44px;
    }
    input:focus, textarea:focus{
      border-color: rgba(255,255,255,.28);
      background: rgba(8,10,14,.60);
      transform: translateY(-1px);
    }
    label{
      display:block;
      margin: 10px 0 6px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.2px;
    }

    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: var(--fg);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:650;
      cursor:pointer;
      transition: transform .14s ease, border-color .18s ease, background .18s ease;
      user-select:none;
    }
    button:hover{border-color: rgba(255,255,255,.26); background: rgba(255,255,255,.14)}
    button:active{transform: translateY(1px) scale(.99)}
    button[disabled]{opacity:.55; cursor:not-allowed}

    .sendBtn{
      width: 46px;
      display:grid;
      place-items:center;
      padding: 0;
      min-height: 56px;
    }
    .sendIcon{
      width: 20px; height: 20px;
      opacity:.95;
    }
    .sendOver{
      position:absolute;
      right: 12px;
      bottom: 12px;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      pointer-events:auto;
    }

    .chat{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 220px;
      overflow:auto;
      padding-right: 6px;
    }
    .bubble{
      align-self:flex-start;
      max-width: 92%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,10,14,.44);
      color: rgba(255,255,255,.90);
      line-height:1.35;
      font-size: 14px;
    }
    .bubble.me{
      align-self:flex-end;
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.12);
    }
    .bubble small{
      display:block;
      margin-top: 6px;
      color: rgba(255,255,255,.60);
      font-size: 12px;
    }

    .step2{
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px dashed rgba(255,255,255,.14);
      display:none;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .foot{
      padding: 14px 26px 22px;
      border-top:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.55);
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .foot a{color: rgba(255,255,255,.75); text-decoration:none; border-bottom:1px solid rgba(255,255,255,.18)}
    .foot a:hover{border-bottom-color:rgba(255,255,255,.35)}
    .status{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .led{
      width:8px; height:8px; border-radius:50%;
      background: rgba(255,255,255,.50);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
      opacity:.9;
    }
    .led.ok{background: rgba(90,255,170,.80); box-shadow: 0 0 0 4px rgba(90,255,170,.12)}
    .led.bad{background: rgba(255,120,120,.85); box-shadow: 0 0 0 4px rgba(255,120,120,.12)}

    @media (max-width: 820px){
      .hint{display:none}
      .cardTop{padding: 22px 18px 16px}
      .cardBody{padding: 16px 18px 18px}
      .foot{padding: 12px 18px 18px}
      .grid2{grid-template-columns: 1fr}
      .grid3{grid-template-columns: 1fr}
    }
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important}
      .fx::after{display:none}
    }
  </style>
</head>

<body>
  <canvas id="bg" aria-hidden="true"></canvas>
  <div class="fx" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <div class="dot" aria-hidden="true"></div>
      <div>
        <b>Singing HUGO</b><br/>
        <span>simple questions, real replies</span>
      </div>
    </div>

    <div class="cta">
      <a class="pill" href="https://filma.singinghugo.com" target="_blank" rel="noopener noreferrer">
        Watch film <span class="k">after registration</span>
      </a>
    </div>
  </header>

  <main>
    <section class="card" role="region" aria-label="Inquiry form">
      <div class="cardTop">
        <div>
          <h1>Welcome.</h1>
          <div class="sub">
            Ask anything about the film, screenings, licensing, festivals, press, or whatever humans worry about.
            Your question is registered instantly, and we’ll get back to you when we’re out of filming mode.
          </div>
        </div>
        <div class="hint">
          <div><b>Tip:</b> want to watch?</div>
          <div>Access is at <a href="https://filma.singinghugo.com" target="_blank" rel="noopener noreferrer">filma.singinghugo.com</a></div>
          <small>(after you leave contact details)</small>
        </div>
      </div>

      <div class="cardBody">
        <form id="qForm" autocomplete="on">
          <label for="question">Your question</label>
          <div class="field">
            <textarea id="question" name="question" placeholder="Ask anything…" required></textarea>
            <button class="sendOver" type="submit" aria-label="Send question">
              <svg class="sendIcon" viewBox="0 0 24 24" fill="none">
                <path d="M3 11.5L21 3l-8.5 18-2.7-7.1L3 11.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="chat" id="chat" aria-live="polite"></div>

          <div class="step2" id="step2">
            <label>Leave contact details (so we can actually reply)</label>
            <div class="grid3">
              <div>
                <input id="name" name="name" placeholder="Name" autocomplete="name"/>
              </div>
              <div>
                <input id="email" name="email" placeholder="Email" type="email" autocomplete="email"/>
              </div>
              <div>
                <input id="phone" name="phone" placeholder="Phone (optional)" autocomplete="tel"/>
              </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap;">
              <button id="contactBtn" type="button">Send contact</button>
              <span style="color: var(--muted); font-size: 12px;">
                If your question was about watching: we’ll point you to <b>filma.singinghugo.com</b> after registration.
              </span>
            </div>
          </div>
        </form>
      </div>

      <div class="foot">
        <div class="status">
          <span class="led" id="netLed" aria-hidden="true"></span>
          <span id="netText">Ready.</span>
        </div>
        <div>
          <a href="#" id="nextBg">Next background</a> ·
          <a href="#" id="clear">Clear</a>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    // ============================
    // CONFIG: Google Sheets endpoint (Apps Script Web App)
    // ============================
    // 1) Create a Google Apps Script Web App that writes to a Spreadsheet (instructions below in chat response).
    // 2) Paste the Web App URL here.
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzKZC2H-t00rNa92zowiOfVX5etZo1seG5_lg8vr35CkEfQ6fTBIG2wm5E5TbJonpCZ/exec";
    const SHARED_TOKEN = "fsrija";

    // ============================
    // UI + logging
    // ============================
    const $ = (s) => document.querySelector(s);
    const qForm = $("#qForm");
    const questionEl = $("#question");
    const chatEl = $("#chat");
    const step2El = $("#step2");
    const contactBtn = $("#contactBtn");
    const netLed = $("#netLed");
    const netText = $("#netText");
    const nextBg = $("#nextBg");
    const clearBtn = $("#clear");

    const state = {
      submissionId: null,
      lastQuestion: "",
      lastBotReply: "",
      hasSentQuestion: false,
      queue: [],
      reducedMotion: window.matchMedia("(prefers-reduced-motion: reduce)").matches,
    };

    function setVH(){
      document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
    }
    setVH();
    window.addEventListener("resize", setVH);

    function nowIso(){
      return new Date().toISOString();
    }
    function uid(){
      // good enough for a website that isn't launching rockets
      return "sh_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 9);
    }

    function addBubble(text, who="bot"){
      const div = document.createElement("div");
      div.className = "bubble" + (who === "me" ? " me" : "");
      div.textContent = text;

      if(who !== "me"){
        const sm = document.createElement("small");
        sm.textContent = "We’re currently filming. Leave contact so we can reply.";
        div.appendChild(sm);
      }
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setNet(ok, msg){
      netLed.classList.remove("ok","bad");
      netLed.classList.add(ok ? "ok" : "bad");
      netText.textContent = msg;
    }
    function setNetNeutral(msg){
      netLed.classList.remove("ok","bad");
      netText.textContent = msg;
    }
    function updateOnlineStatus(){
      if(navigator.onLine) setNet(true, "Online. Logging enabled.");
      else setNet(false, "Offline. Will retry when back online.");
    }
    window.addEventListener("online", updateOnlineStatus);
    window.addEventListener("offline", updateOnlineStatus);
    updateOnlineStatus();

    // ============================
    // "Chat" reply logic (simple on purpose)
    // ============================
    function botReply(qRaw){
      const q = (qRaw || "").toLowerCase().trim();
      const wantsWatch = /watch|screen|stream|link|where|how.*watch|view|see.*film|filma/.test(q);
      const wantsPress = /press|trailer|stills|poster|kit|epk/.test(q);
      const wantsRights = /license|licensing|rights|distribution|territor|sales/.test(q);
      const wantsFestival = /festival|screening|cinema|premiere|q&a/.test(q);

      if(wantsWatch){
        return "Watching is possible after registration. Leave your contact, and we’ll send access details for filma.singinghugo.com when we’re back from filming.";
      }
      if(wantsPress){
        return "Press materials can be shared. Leave contact (and your outlet), and we’ll follow up once we’re back from filming.";
      }
      if(wantsRights){
        return "Licensing/distribution questions are welcome. Leave contact and territory details, and we’ll reply after the shoot.";
      }
      if(wantsFestival){
        return "Screenings/festivals are possible depending on dates and availability. Leave contact and your timeline; we’ll respond after filming.";
      }
      return "Got it. We’re currently filming, but your question is registered. Leave your contact details and we’ll get back to you when we’re back.";
    }

    // ============================
    // Google Sheets logging (no-cors safe POST)
    // ============================
    function loadQueue(){
      try{
        const raw = localStorage.getItem("sh_queue");
        state.queue = raw ? JSON.parse(raw) : [];
      }catch(e){ state.queue = []; }
    }
    function saveQueue(){
      try{ localStorage.setItem("sh_queue", JSON.stringify(state.queue)); }catch(e){}
    }
    loadQueue();

    async function postToSheets(payload){
      if(!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.includes("PASTE_")){
        // not configured yet
        setNetNeutral("Not connected to Sheets yet. Configure SHEETS_WEBAPP_URL in index.html.");
        return;
      }

      // Apps Script + no-cors: we can't read the response, so we generate submissionId on the client.
      const data = new URLSearchParams();
      Object.entries(payload).forEach(([k,v]) => data.set(k, String(v ?? "")));

      try{
        await fetch(SHEETS_WEBAPP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: data.toString()
        });
        // If fetch resolves, we assume it reached the endpoint.
      }catch(err){
        // Network failure: queue for retry.
        state.queue.push(payload);
        saveQueue();
        throw err;
      }
    }

    async function flushQueue(){
      if(!navigator.onLine) return;
      if(!state.queue.length) return;
      const copy = [...state.queue];
      state.queue = [];
      saveQueue();
      for(const item of copy){
        try{ await postToSheets(item); }
        catch(e){
          // put back remaining + this
          state.queue = [item, ...copy.slice(copy.indexOf(item)+1), ...state.queue];
          saveQueue();
          break;
        }
      }
    }
    flushQueue();
    window.addEventListener("online", flushQueue);

    function basePayload(){
      return {
        token: SHARED_TOKEN,
        page: location.href,
        referrer: document.referrer || "",
        ua: navigator.userAgent,
        ts: nowIso()
      };
    }

    // ============================
    // Step 1: submit question
    // ============================
    qForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = questionEl.value.trim();
      if(!q) return;

      // lock in session id on first question
      if(!state.submissionId) state.submissionId = uid();
      state.lastQuestion = q;

      addBubble(q, "me");
      questionEl.value = "";

      const reply = botReply(q);
      state.lastBotReply = reply;
      addBubble(reply, "bot");

      // show contact step
      step2El.style.display = "block";
      state.hasSentQuestion = true;

      // log question immediately
      const payload = {
        ...basePayload(),
        action: "question",
        submissionId: state.submissionId,
        question: q,
        botReply: reply
      };

      try{
        await postToSheets(payload);
        setNet(true, "Question registered.");
        flushQueue();
      }catch(err){
        setNet(false, "Couldn’t send (network). Will retry.");
      }

      // subtle animation cue (if allowed)
      if(!state.reducedMotion){
        const { gsap } = await import("https://cdn.jsdelivr.net/npm/gsap@3.12.5/index.js");
        gsap.fromTo(step2El, {opacity:0, y:8}, {opacity:1, y:0, duration:.55, ease:"power2.out"});
      }
    });

    // Step 2: submit contact
    contactBtn.addEventListener("click", async () => {
      if(!state.submissionId || !state.hasSentQuestion){
        addBubble("Please ask a question first. The universe demands order.", "bot");
        return;
      }

      const name = $("#name").value.trim();
      const email = $("#email").value.trim();
      const phone = $("#phone").value.trim();

      if(!email && !phone){
        addBubble("Drop at least an email (or phone) so we can actually reach you.", "bot");
        return;
      }

      contactBtn.disabled = true;

      const payload = {
        ...basePayload(),
        action: "contact",
        submissionId: state.submissionId,
        name, email, phone,
        question: state.lastQuestion,
        botReply: state.lastBotReply
      };

      try{
        await postToSheets(payload);
        setNet(true, "Contact saved. We’ll reach out after filming.");
        addBubble("Registered. When we’re back from filming, we’ll contact you. Thanks for being patient (a rare human skill).", "bot");
        flushQueue();
      }catch(err){
        setNet(false, "Couldn’t send contact (network). Will retry.");
        // queue for retry is already handled in postToSheets on network failure
      }finally{
        contactBtn.disabled = false;
      }
    });

    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      chatEl.innerHTML = "";
      step2El.style.display = "none";
      state.submissionId = null;
      state.lastQuestion = "";
      state.lastBotReply = "";
      state.hasSentQuestion = false;
      $("#name").value = "";
      $("#email").value = "";
      $("#phone").value = "";
      setNetNeutral("Ready.");
    });

    // ============================
    // WebGL / Three.js background: cursor-reactive flow + "carousel" transitions
    // ============================
    const canvas = document.getElementById("bg");

    // Respect reduced motion by degrading gracefully
    if(state.reducedMotion){
      const ctx = canvas.getContext("2d");
      function paint(){
        const w = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
        const h = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
        const g = ctx.createLinearGradient(0,0,w,h);
        g.addColorStop(0, "#0b0d12");
        g.addColorStop(1, "#141828");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);
      }
      paint();
      window.addEventListener("resize", paint);
    } else {
      const THREE = await import("https://unpkg.com/three@0.160.0/build/three.module.js");
      const { gsap } = await import("https://cdn.jsdelivr.net/npm/gsap@3.12.5/index.js");

      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true, powerPreference:"high-performance" });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 1.6));
      renderer.setSize(window.innerWidth, window.innerHeight, false);

      const scene = new THREE.Scene();
      const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);

      // Procedural "slides"
      function makeSlide(seed){
        const c = document.createElement("canvas");
        c.width = 1024; c.height = 1024;
        const ctx = c.getContext("2d");

        // deterministic-ish random
        let s = seed * 99991;
        const rnd = () => (s = (s * 1664525 + 1013904223) % 4294967296) / 4294967296;

        const a = rnd(), b = rnd(), d = rnd();
        const col1 = `hsl(${Math.floor(180 + a*160)}, 70%, ${Math.floor(32 + b*18)}%)`;
        const col2 = `hsl(${Math.floor( 20 + d*260)}, 70%, ${Math.floor(18 + a*20)}%)`;

        const g = ctx.createLinearGradient(0, 0, c.width, c.height);
        g.addColorStop(0, col1);
        g.addColorStop(1, col2);
        ctx.fillStyle = g;
        ctx.fillRect(0,0,c.width,c.height);

        // soft blobs
        for(let i=0;i<60;i++){
          const x = rnd()*c.width, y = rnd()*c.height;
          const r = 40 + rnd()*160;
          const gg = ctx.createRadialGradient(x,y,0,x,y,r);
          gg.addColorStop(0, `hsla(${Math.floor(180 + rnd()*220)}, 90%, 65%, ${0.10 + rnd()*0.12})`);
          gg.addColorStop(1, "rgba(0,0,0,0)");
          ctx.fillStyle = gg;
          ctx.beginPath();
          ctx.arc(x,y,r,0,Math.PI*2);
          ctx.fill();
        }

        // subtle scanlines
        ctx.globalAlpha = 0.06;
        ctx.fillStyle = "#000";
        for(let y=0;y<c.height;y+=3){
          ctx.fillRect(0,y,c.width,1);
        }
        ctx.globalAlpha = 1;

        const tex = new THREE.CanvasTexture(c);
        tex.wrapS = tex.wrapT = THREE.ClampToEdgeWrapping;
        tex.minFilter = THREE.LinearFilter;
        tex.magFilter = THREE.LinearFilter;
        return tex;
      }

      const slides = Array.from({length: 7}, (_, i) => makeSlide(i+1));
      let slideIndex = 0;

      const uniforms = {
        uTime: { value: 0 },
        uMouse: { value: new THREE.Vector2(0.5, 0.5) },
        uMouseVel: { value: new THREE.Vector2(0.0, 0.0) },
        uTexA: { value: slides[0] },
        uTexB: { value: slides[1] },
        uMix: { value: 0.0 },
        uAspect: { value: window.innerWidth / Math.max(1, window.innerHeight) },
      };

      const material = new THREE.ShaderMaterial({
        uniforms,
        vertexShader: /* glsl */`
          varying vec2 vUv;
          void main(){
            vUv = uv;
            gl_Position = vec4(position, 1.0);
          }
        `,
        fragmentShader: /* glsl */`
          precision highp float;
          varying vec2 vUv;
          uniform float uTime;
          uniform float uMix;
          uniform vec2 uMouse;
          uniform vec2 uMouseVel;
          uniform float uAspect;
          uniform sampler2D uTexA;
          uniform sampler2D uTexB;

          float hash(vec2 p){
            p = fract(p * vec2(123.34, 345.45));
            p += dot(p, p + 34.345);
            return fract(p.x * p.y);
          }
          float noise(vec2 p){
            vec2 i = floor(p);
            vec2 f = fract(p);
            float a = hash(i);
            float b = hash(i + vec2(1.0, 0.0));
            float c = hash(i + vec2(0.0, 1.0));
            float d = hash(i + vec2(1.0, 1.0));
            vec2 u = f*f*(3.0-2.0*f);
            return mix(a, b, u.x) + (c-a)*u.y*(1.0-u.x) + (d-b)*u.x*u.y;
          }

          vec2 coverUv(vec2 uv, float texAspect, float screenAspect){
            // cover fit: keep center, fill screen
            vec2 u = uv - 0.5;
            if(screenAspect > texAspect){
              u.x *= screenAspect / texAspect;
            } else {
              u.y *= texAspect / screenAspect;
            }
            return u + 0.5;
          }

          void main(){
            vec2 uv = vUv;

            // mouse-driven flow
            vec2 m = uMouse;
            vec2 toM = uv - m;
            float dist = length(toM);

            float n = noise(uv*3.0 + uTime*0.08);
            float swirl = sin((uv.x + uv.y + uTime*0.12) * 6.283) * 0.01;
            vec2 drift = vec2(
              sin(uTime*0.18 + uv.y*5.0),
              cos(uTime*0.16 + uv.x*4.2)
            ) * 0.01;

            vec2 vel = uMouseVel * 0.8;
            vec2 warp = (toM) * (0.08 * exp(-dist*3.2)) + drift + vel*0.02;
            warp += (n - 0.5) * 0.02;

            float texAspect = 1.0;
            vec2 cuv = coverUv(uv + warp + vec2(swirl), texAspect, uAspect);

            vec4 a = texture2D(uTexA, cuv);
            vec4 b = texture2D(uTexB, cuv);

            // transition mask
            float edge = smoothstep(0.15, 0.85, uMix + (n - 0.5) * 0.25);
            vec4 col = mix(a, b, edge);

            // film-ish contrast
            col.rgb = pow(col.rgb, vec3(0.92));
            col.rgb *= 1.05;

            // vignette
            float v = smoothstep(0.95, 0.2, dist);
            col.rgb *= 0.65 + 0.35*v;

            gl_FragColor = col;
          }
        `,
      });

      const mesh = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material);
      scene.add(mesh);

      // Mouse tracking with velocity smoothing
      const mouse = new THREE.Vector2(0.5,0.5);
      const mousePrev = new THREE.Vector2(0.5,0.5);
      const mouseVel = new THREE.Vector2(0,0);

      function onPointerMove(ev){
        const x = ev.clientX / window.innerWidth;
        const y = 1.0 - (ev.clientY / window.innerHeight);
        mouse.set(x, y);
      }
      window.addEventListener("pointermove", onPointerMove, {passive:true});

      // also allow gentle movement on scroll/touch
      window.addEventListener("touchmove", (ev) => {
        if(!ev.touches || !ev.touches[0]) return;
        onPointerMove(ev.touches[0]);
      }, {passive:true});

      function nextSlide(){
        const next = (slideIndex + 1) % slides.length;
        uniforms.uTexA.value = slides[slideIndex];
        uniforms.uTexB.value = slides[next];
        uniforms.uMix.value = 0.0;
        slideIndex = next;

        gsap.to(uniforms.uMix, { value: 1.0, duration: 1.65, ease: "power2.inOut" });
      }

      // auto carousel
      let carouselTimer = setInterval(nextSlide, 7000);

      nextBg.addEventListener("click", (e) => {
        e.preventDefault();
        nextSlide();
        clearInterval(carouselTimer);
        carouselTimer = setInterval(nextSlide, 7000);
      });

      // Keyboard shortcut
      window.addEventListener("keydown", (e) => {
        if(e.key.toLowerCase() === "b") nextSlide();
      });

      function onResize(){
        renderer.setSize(window.innerWidth, window.innerHeight, false);
        uniforms.uAspect.value = window.innerWidth / Math.max(1, window.innerHeight);
      }
      window.addEventListener("resize", onResize);

      // GSAP: card entrance
      gsap.from(".card", { y: 18, opacity: 0, duration: 0.8, ease: "power2.out" });
      gsap.from("header .brand", { y: -10, opacity: 0, duration: 0.8, ease: "power2.out", delay: 0.1 });
      gsap.from("header .pill", { y: -10, opacity: 0, duration: 0.8, ease: "power2.out", delay: 0.16 });

      const clock = new THREE.Clock();
      function animate(){
        const t = clock.getElapsedTime();
        uniforms.uTime.value = t;

        // smooth mouse and velocity
        const lerpAmt = 0.08;
        uniforms.uMouse.value.lerp(mouse, lerpAmt);

        mouseVel.copy(uniforms.uMouse.value).sub(mousePrev);
        mousePrev.copy(uniforms.uMouse.value);

        uniforms.uMouseVel.value.lerp(mouseVel, 0.15);

        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();
    }
  </script>
</body>
</html>
